---
layout: post
title: FEMU/nvme源码分析
author: Liu Shi
tags:
    - femu
    - nvme
---

## 写在前面

NVM Express协议（简称NVMe协议）在2007年被Intel提出，是一种以PCIe为基础，针对非易失内存的主机与子系统通信的协议，目前，已经逐步迭代更新至NVMe1.4。

本文以FEMU对nvme协议实现的源码为基础，展开对nvme工作原理的分析。

## 相关协议的区别

传统机械盘和固态盘连接在SATA总线，使用的主机传输协议是[AHCI](https://zh.wikipedia.org/zh-cn/AHCI)协议，而现代告诉存储设备连接在PCIe总线，使用的主机传输协议是NVMe，他们的[区别](https://www.kingston.com/cn/community/articledetail/articleid/48543)是：
|AHCI|NVMe|
|-|-|
|针对旋转磁盘技术优化| 针对闪存固态盘优化|
|只有一个命令队列|多达64K命令队列|
|队列深度为32|队列深度为64K|
|高占用CPU|低占用CPU|
|延迟为6us|延迟为2.8us|
|必须与SATA控制器通信|直接与系统CPU通信|
|最大IOPS为10万|最大IOPS超过100万|

## NVMe协议

NVMe协议在主机端和设备端均需做实现，在Linux+FEMU架构下，Linux实现主机端NVMe，而FEMU实现设备端NVMe。

Linux关于NVMe的源码位于`include/linux/nvme.h`和`drivers/nvme`，其中host表示当前系统作为主机与NVMe盘交互数据，target表示将当前系统封装成NVMe盘，与其他主机交互，target主要用于网络通信中。本文关注host目录源码。

FEMU关于NVMe的源码位于`hw/block/femu`。

### 数据结构

#### 提交队列和完成队列

环形队列，尾指针指向队尾元素的下一个位置，头指针指向队首元素。I/O完成队列和I/O提交队列的最大槽位数是64Ki，并且由`CAP.MQES`指定。Admin提交队列和完成队列的最大槽位数是4Ki。

#### 提交队列项

命令大小64字节，格式如下：

|字节|描述|
|-|-|
|03:00|Command Dword0 (CWD0): 31-16位表示命令标识CID，15-14位表示用于传输数据的方式PSDT，PRP还是SGL，13-10**保留**，09-08组合操作FUSE，07-00操作码opcode|
|07:04|命令空间标识NSID|
|15:08|**保留**|
|23:16|元数据指针mptr,只有在命令有元数据，并且元数据没有与数据的逻辑块交织时有效，并且元数据的地址标识方式由`cdw0.psdt`决定|
|39:24|数据指针dptr|
|43:40|Command Dword10 (CWD10),在具体命令中被指定含义|
|47:44|Command Dword11 (CWD11),在具体命令中被指定含义|
|51:48|Command Dword12 (CWD12),在具体命令中被指定含义|
|55:42|Command Dword13 (CWD13),在具体命令中被指定含义|
|59:46|Command Dword14 (CWD14),在具体命令中被指定含义|
|63:60|Command Dword15 (CWD15),在具体命令中被指定含义|

FEMU的submmission queue entry的源码：

```c
typedef struct NvmeCmd {
    uint8_t     opcode;
    uint8_t     fuse;
    uint16_t    cid;
    uint32_t    nsid;
    uint64_t    res1;
    uint64_t    mptr;
    uint64_t    prp1;
    uint64_t    prp2;
    uint32_t    cdw10;
    uint32_t    cdw11;
    uint32_t    cdw12;
    uint32_t    cdw13;
    uint32_t    cdw14;
    uint32_t    cdw15;
} NvmeCmd;
```

#### 完成队列项

命令大小16字节，格式如下：

|字节|描述|
|-|-|
|15:12|DW0,在具体命令中被指定含义|
|11:08|DW1，**保留**|
|07:04|DW2,31-16位表示提交队列标识sqid,15-0位表示提交队列头指针sqhd|
|03:00|DW3,31-17位表示正在完成的命令的状态sf，16位表示表示完成队列是否是新的，完成队列是环形队列，每次走完一个环形时，Phase Tag被翻转，15-0位表示正在完成的命令的标识cid,一个请求队列一次最多未完成的命令个数是64Ki(队列深度)|

FEMU中completion queue entry的源码：

```c
typedef struct NvmeCqe {
    union {
        struct {
            uint32_t    result;
            uint32_t    rsvd;
        } n;
        uint64_t res64;
    };
    uint16_t    sq_head;
    uint16_t    sq_id;
    uint16_t    cid;
    uint16_t    status;
} NvmeCqe;
```

<u>DMA数据传输的地址是指物理地址，NVMe协议描述数据传输地址的方式提供两种：PRP和SGL，Admin命令只能使用PRP传输数据，而IO命令可以用PRP或者SGL传输数据，并且由`cwd0.pstd`指定。</u>

#### PRP和SGL

- PRP：由PRP1和PRP2表示传输的物理页地址，当传输的物理页无法有两个PRP表示，则PRP可以表示PRP Lists，并且每个指向的物理页的最后一个prp项指向下一个PRP Lists页。
- SGL：由于PRP只能表示一个个物理页，SGL能表示起始地址+长度，

### Admin命令

### IO命令

### NVMe架构

### 相关资料

- [NVM-Express-1_4b-2020.09.21-Ratified.pdf](https://nvmexpress.org/wp-content/uploads/NVM-Express-1_4b-2020.09.21-Ratified.pdf)